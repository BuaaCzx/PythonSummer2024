<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>分组检测</title>
    <script type="importmap">
        {
            "imports": {
                "vue": "https://unpkg.com/vue@3.4.29/dist/vue.esm-browser.js",
                "axios": "https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"
            }
        }
    </script>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../static/js/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/theme/vintage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-markup.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        #chart-container {
            width: 100%;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .echarts-container {
            height: 100%;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
        }
        .modal-dialog {
            max-width: 90%;
            max-height: 90%;
        }
        .modal-content {
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
<div id="app" class="container-fluid"></div>

<!-- Modal -->


<script type="module">
    import { createApp } from 'vue';
    import sideBar from "../static/js/sideBar.js";

    const highlightDirective = {
        mounted(el) {
            Prism.highlightElement(el);
        },
        updated(el) {
            Prism.highlightElement(el);
        }
    };

    const app = createApp({
        components: {
            sideBar
        },
        directives: {
            highlight: highlightDirective
        },
        data() {
            return {
                now: "分组检测",
                results: [],
                graphData: [],
                showModal: false,
                modalSourceCode: '',
                modalTargetCode: ''
            };
        },
        methods: {
            handleFileChange(event) {
                const files = event.target.files;
                if (files && files.length > 0) {
                    const formData = new FormData();
                    for (let i = 0; i < files.length; i++) {
                        formData.append('files', files[i]);
                    }
                    formData.append('comparison_type', 'group');

                    axios.post('/api/comparison/', formData)
                        .then(response => {
                            this.results = response.data.result;
                            console.log(this.results);
                            this.graphData = this.generateGraphData();
                            console.log(this.graphData);
                            this.updateChart();
                        })
                        .catch(error => {
                            console.error('Error uploading files:', error);
                        });
                }
            },

            generateGraphData() {
                const nodes = [];
                const links = [];
                const categories = [];
                const results = this.results;
                for (let i = 0; i < results.length; i++) {
                    // 处理分类
                    categories.push({
                        name: `Category ${i + 1}`
                    });
                    const len = results[i].file_names.length;
                    const result_name = results[i].file_names;
                    const result_content = results[i].file_contents;
                    // 处理节点
                    for (let j = 0; j < len; j++) {
                        nodes.push({
                            name: result_name[j],
                            symbolSize: len * 8,
                            category: i,
                            content: result_content[j]
                        });
                    }
                    // 处理边
                    for (let j = 0; j < len; j++) {
                        for (let k = j + 1; k < len; k++) {
                            links.push({
                                source: result_name[j],
                                target: result_name[k]
                            });
                        }
                    }
                }
                return { nodes, links, categories };
            },

            updateChart() {
                const chartContainer = document.getElementById('chart1');
                if (chartContainer) {
                    var myChart = echarts.init(chartContainer, 'vintage');
                    const { graphData } = this;

                    const option = {
                        title: {
                            text: '分组检测图',
                            top: 'top',
                            left: 'left'
                        },
                        tooltip: {},
                        legend: [
                            {
                                data: graphData.categories.map(a => a.name)
                            }
                        ],
                        animationDuration: 1500,
                        animationEasingUpdate: 'quinticInOut',
                        series: [
                            {
                                name: '分组检测',
                                type: 'graph',
                                layout: 'force',
                                data: graphData.nodes,
                                links: graphData.links,
                                categories: graphData.categories,
                                roam: true,
                                label: {
                                    show: true,
                                    position: 'right',
                                    formatter: '{b}'
                                },
                                lineStyle: {
                                    color: 'source',
                                    curveness: 0.3
                                },
                                emphasis: {
                                    focus: 'adjacency',
                                    lineStyle: {
                                        width: 10
                                    }
                                },
                                force: {
                                    repulsion: 200,
                                    edgeLength: [50, 150]
                                }
                            }
                        ]
                    };

                    myChart.setOption(option);

                    // Event listener for edge clicks
                    myChart.on('click', (params) => {
                        if (params.componentType === 'series' && params.seriesType === 'graph' && params.dataType === 'edge') {
                            const { data } = params;
                            const sourceNode = graphData.nodes.find(node => node.name === data.source);
                            const targetNode = graphData.nodes.find(node => node.name === data.target);
                            if (sourceNode && targetNode) {
                                this.modalSourceCode = sourceNode.content;
                                this.modalTargetCode = targetNode.content;
                                this.showModal = true;
                                // Trigger modal display manually
                                const modalElement = document.getElementById('codeModal');
                                if (modalElement) {
                                    const modal = new bootstrap.Modal(modalElement);
                                    modal.show();
                                }
                                // console.log(this.modalSourceCode);
                                // console.log(this.modalTargetCode);
                            }
                        }
                    });
                } else {
                    console.error("Chart container not found!");
                }
            },

            closeModal() {
                this.showModal = false;
                const modalElement = document.getElementById('codeModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                }
            },

            handleBackdropClick(event) {
                if (event.target.classList.contains('modal-backdrop')) {
                    this.closeModal();
                }
            }
        },
        mounted() {
            Prism.highlightAll();
            document.addEventListener('click', this.handleBackdropClick);
        },
        beforeUnmount() {
            document.removeEventListener('click', this.handleBackdropClick);
        },
        computed: {
            showExportButton() {
                return this.results.length > 0;
            }
        },
        template: `
            <div class="d-flex flex-row" style="margin-left: clamp(200px, 20vw, 20vw); padding: 15px;">
                <side-bar :now="now"></side-bar>
                <div style="flex-grow: 1; display: flex; flex-direction: column; padding: 20px;">
                    <div class="navbar d-flex justify-content-between align-items-center">
                        <h1 style="margin-bottom: 0;">分组查询</h1>
                        <button type="button" class="btn btn-dark" onclick="document.getElementById('fileInput').click();">上传文件</button>
                        <input type="file" id="fileInput" accept=".txt,.py,.js,.html,.css" multiple hidden ref="fileInput" @change="handleFileChange">
                    </div>
                    <div id="chart1" style="width: 100%; height: 560px; margin-top: 20px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal fade" id="codeModal" tabindex="-1" aria-labelledby="codeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="codeModalLabel">代码展示</h5>
                            <button type="button" class="btn-close" aria-label="Close" @click="closeModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col">
                                    <h6>Source Code</h6>
                                    <pre><code class="language-python" v-highlight v-html="modalSourceCode"></code></pre>
                                </div>
                                <div class="col">
                                    <h6>Target Code</h6>
                                    <pre><code class="language-python" v-highlight v-html="modalTargetCode"></code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
    });

    app.mount("#app");
</script>

</body>
</html>
